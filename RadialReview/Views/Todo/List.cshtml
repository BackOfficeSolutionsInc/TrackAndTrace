@model long
@{
	ViewBag.Title = "List";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<div ng-app="L10App" class="meeting-review ng-cloak">
	<div ng-controller="L10Controller">
		<div class="pull-left"><h3 style="margin-top: 5px;">{{model.Name}}</h3></div>
		<div class="calendar-container pull-right" style="width:240px;">
			<i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
			<input date-range-picker id="daterange3" class="form-control date-picker" type="text" name="date" ng-model="date" options="opts" required placeholder="Select a date range..." />
			<b class="caret"></b>
		</div>
		<div style="height:40px"></div>


		<div id="Todo" class="tab-pane todo-pane">

			<div ng-repeat="(key,value) in model.Todos | transform:this | groupBy: 'Owner.Name'">
				<table width="100%" class="component" ng-show="(value | filter:filters.byRange('CompleteTime',date.startDate,date.endDate)).length">
					<tr ng-show="$first">
						<td></td>
						<td></td>
						<th>Todo</th>
						<th class="alignCenter">Due Date</th>
						<th></th>
						<th>Completed</th>
					</tr>
					@*| orderBy: ['Complete','-CompleteTime','Name']*@
					<tr ng-repeat-start="todo in value | orderBy: ['Complete','-CompleteTime','DueDate'] | filter:filters.byRange('CompleteTime',date.startDate,date.endDate) "
						ng-class="{grayRow: todo.Complete}"
						ng-hide="model.Selected==todo.Key"
						class="clickable">
						<td style="min-width: 25px;text-align: center;">
							<a name="todo_{{todo.Id}}"></a>
							<input type="checkbox" ng-model="todo.Complete" ng-change="functions.updateComplete(this);functions.sendUpdate(todo)" />
						</td>
						<td><profile-image user="todo.Owner"></profile-image></td>
						<td style="width:100%" ng-click="model.Selected = todo.Key">{{todo.Name}}</td>
						<td class="alignCenter" style="min-width: 80px;"><input ng-class="todo.Complete?(''):(todo.DueDate>now? 'green' : 'red')" class="due-date" data-todo="{{todo.Id}}" type="text" value="{{todo.DueDate | date:'MM/dd/yyyy'}}" /></td>
						<td style="min-width: 15px;"></td>
						<td class="alignCenter" style="min-width: 75px;">{{todo.CompleteTime | date:'MM/dd/yy'}}</td>
					</tr>

					<tr ng-show="model.Selected==todo.Key" ng-class="{grayRow: todo.Complete}">
						<td style="min-width: 25px;text-align: center;"><input type="checkbox" ng-model="todo.Complete" ng-change="functions.updateComplete(this);functions.sendUpdate(todo)" /></td>
						<td><profile-image user="todo.Owner"></profile-image></td>
						<td style="width:100%">
							<input ng-model-options="{debounce: 200}" type="text" ng-model="todo.Name" class="fullWidth" ng-change="functions.sendUpdate(todo)" />
						</td>
						<td class="alignCenter" style="min-width: 75px;"><input class="due-date" data-todo="{{todo.Id}}" type="text" value="{{todo.DueDate | date:'MM/dd/yyyy'}}" /></td>
						<td style="min-width: 15px;"></td>
						<td class="alignCenter" style="min-width: 75px;">{{todo.CompleteTime | date:'MM/dd/yy'}}</td>
					</tr>
					<tr ng-repeat-end style="color:gray" ng-show="model.Selected==todo.Key" ng-class="{grayRow: todo.Complete}">
						<td></td>
						<td></td>
						<td><textarea ng-model-options="{debounce: 200}" class="fullWidth verticalOnly" ng-model="todo.Details" placeholder="Enter todo details..." style="min-height: 100px;" ng-change="functions.sendUpdate(todo)"></textarea></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>

				</table>
			</div>

			<div class="gray" style="padding: 30px 15px;" ng-show="(model.Todos | transform:this | filter:filters.byRange('CompleteTime',date.startDate,date.endDate)).length==0">
				No todos fit your search criteria.
			</div>

		</div>
	</div>
</div>


@using (Html.BeginStyles())
{
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.0-rc.1/angular.min.js"></script>
	@Styles.Render("~/styles/L10")
	@Styles.Render("~/styles/meeting")
	<style>
		input.due-date {
			border: none;
			width: 75px;
			text-decoration: none;
			color: #767F99;
			text-align: center;
			background-color: rgba(0, 0, 0, 0);
			cursor: pointer;
		}
	</style>
}

@using (Html.BeginScripts())
{
	<script src="~/Scripts/jquery/jquery.ba-throttle-debounce.js"></script>
	<script src="https://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-filter/0.5.4/angular-filter.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
	@Scripts.Render("~/bundles/meeting")

	<script src="~/Scripts/L10/L10.js"></script>
	<script>
		angular.module('L10App')
			.value('meetingId',-3)
			.value('meetingDataUrlBase', '/Todo/ListData/@Model?');
		$('#pages a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});
		$(function() {

			setTimeout(function() {
				var $element = $('#daterange3');
				var scope = angular.element($element).scope();
				scope.date = {
					startDate: moment().subtract('days', 1).toDate(),
					endDate: moment().add('days', 2).toDate()
				};
			},1);

			$("body").on("click", ".issuesModal", function() {
				var parm = $.param($(this).data());
				var m = $(this).data("method");
				if (!m)
					m = "Modal";
				showModal("Add an issue", "/Issues/" + m + "?" + parm, "/Issues/" + m);
			});

			$("body").on("click", ".todoModal", function() {
				var parm = $.param($(this).data());
				var m = $(this).data("method");
				if (!m)
					m = "Modal";
				showModal("Add a to-do", "/Todo/" + m + "?" + parm, "/Todo/" + m);
			});

			$("body").on("click", ".measurableModal", function() {
				var m = $(this).data("recurrence");
				showModal('Add Measurable', '/L10/AddMeasurable/' + m, '/L10/AddMeasurable/');
			});

			$("body").on('click', "input.due-date", function () {
				if (!$(this).attr("init")) {
					var now = new Date();
					var todo = $(this).data("todo");
					$(this).datepicker({
						format: 'mm/dd/yyyy',
						todayBtn:true
					}).on('changeDate', function (ev) {
						var data = { date: ev.date.valueOf() };
						$.ajax({
							method: "POST",
							data: data,
							url: "/L10/UpdateTodoDate/" + todo,
							success: function (dd) {
								showJsonAlert(dd);
							}
						});
					});
					$(this).attr("init", 1);
					$(this).blur();
					var that = this;
					setTimeout(function () {
						$(that).datepicker("show");
					}, 10);
				}
			});
		});
	</script>
}